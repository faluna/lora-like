# LoRaとLoRaWAN
## LoraとLoRaWANのちがい?
率直に言えば，
> <div style="text-align: center;">
>   LoRa = 物理層(Physical Layer)
>   LoRaWAN = MAC層(MAC Layer)
> </div>
LoRaはlong-range communication であり，物理層として定義される.  
LoRaWANは通信プロトコルでありネットワークのシステムアーキテクチャである．  
  
LoRaは low power high ratio budget通信を可能とする無線変調である.
LoRaWANは通信においてLoRaを用いているネットワークプロトコルである.
  
LoRaWANではないネットワークにおいてもLoRa変調を利用することが可能.
LoRa通信を行わないネットワークでもLoRaWANを利用することが可能だが，実用ではない.
  
LoRaはチャープスペクトル拡散(CSS: Chirp Spread Spectrum)変調であり，異なる拡散ファクターを使用するので異なるデータレートを与える．
LoRaWANは広範囲を収容するためWide Area Network(WAN)として利用される無線ネットワークである.
  
LoRaはよくLPWAN通信システム全体と表現され誤用されているが，厳密に言えば，LoRaはSemtechが所有している変調方式である．
  
# LoRa: シンボル生成(Symbol Generation)
LoRaは無線ネットワーク規格をベースとしているチャープスペクトル拡散(CSS)である．

## Chirp
> チャープ(Chirp)は'<font color="Red">C</font>ompressed <font color="Red">High</font> <font color="Red">I</font>ntensity <font color="Red">R</font>adar <font color="Red">P</font>ulse'を表している．チャープは時間とともに周波数が増加あるいは減少する信号である．水中音波探知機やレーダーでは一般的である．スペクトル拡散においても用いられる．

## チャープスペクトル拡散(CSS)
CSSはレーダーアプリケーション向けに開発されてきた．チャープ信号は一定の振幅を持ち，ある時間内で線形あるいは非線形に変化していく帯域幅を通過する.CSSは信号を送信するために全ての帯域幅を使用する．周波数の変化が増加であればアップチャープと呼ばれ，減少であればダウンチャープと呼ばれる．次に線形アップチャープの例を示す．(参考文献先参照)
  
* CSSは遠距離へに信号を送信することが可能
* 帯域幅と時間の積は常に1より大きくなる(BT > 1）．
* CSSはドップラーシフトに耐性がある．
* 小電力，低データレート向けに利用される．

## LoRa CSS変調
LoRaは3つの帯域幅:125kHz, 250kHz, 500kHz(ここでは125kHzを使う)を使用する．LoRaシンボルは125kHz帯域幅に渡ってアップチャープされ異なる(準)直交拡散ファクターは要求されるデータレートとチャネル状態を元に使用される．LoRaはSF7からSF12の拡散ファクターが用いられる．これは異なる拡散ファクターでのスペクトルグラムである(参考文献先参照)
  
LoRaの物理層は8つの事前シンボル(preamble symbols)，2つの同期シンボル(symchronisation symbols)，ペイロード(physical payload)，オプションであるがCRCを含む.
* SF8はSF7のちょうど2倍の時間がかかり，SF9はSF8のちょうど2倍の時間がかかる．
* シンボルレート$R\_s$，帯域幅BW，拡散ファクターSFの関係は
$$R\_s = BW / (2^{SF})$$
* 高SFは長時間に渡って信号を送信する
* 低SFは高データレートである.
  
これはLoRaの物理層におけるスペクトルである(参考文献参照)
初めの8アップチャープシンボルはLoRaチャープを検出するために使用されるpreamable シンボルである．次の2ダウンチャープシンボルは時間同期に使用される同期シンボルであり，その後に5変調シンボル(payload)が続く．周波数のジャンプは変調シンボルを表す．

# LoRa: 直交性
異なるchirpynessで送信される信号は常に直交する．異なるチャープレートは異なる拡散ファクタSF そして/あるいは 異なる帯域幅BWによって決まる．この方法でのLoRaシンボルは干渉なしに同じチャネル上で同時に送信と受信が可能となる．  
LoRaは6つのSF(7~12)をもち，3種類の帯域幅(125kHz, 250kHz, 500kHz)をもつ． 
全ての拡散ファクタSFと帯域幅BWの組み合わせが直交するわけではないことを示す．
数学的に簡単に示すことができ，
$$ Symbol rate = BW / (2^{SF})$$
と
$$ Chirp rate = BW * (Symbol rate)$$
から
$$ Chirp rate = BW * BW / (2^{SF})$$
である. 例えば
1. $SF=7, BW=125kHz$
1. $SF=9, BW=250kHz$
  
上のどちらもchirp rateを計算すると同じになる．したがって，これらの組み合わせは直交ではなく同じチャネル上で使用することはできない．
以下のスペクトルを見ると(参考文献参照)  
3種類の異なる組み合わせがプロットされている．
* SF: 07 & BW: 125kHz
* SF: 09 & BW: 250kHz
* SF: 11 & BW: 500kHz
ラインの勾配は直交性を表す．先ほどの3つのラインの勾配は全て同じである．したがって，それら3種類は直交ではない.  
次に直交している組み合わせのスペクトルを表す(参照)
  
この組み合わせ例は
* SF: 10 & BW: 125kHz
* SF: 11 & BW: 250kHz
* SF: 12 & BW: 500kHz
3ケース全てのbit rateは異なっている，それゆえ，これらは直交している組み合わせであり送信において同じチャネル上で使用できる．
  
次に，ある組み合わせが直交か非直交であるかを表すリストを示す(参照)
表のxが非直交組み合わせを表している.

# LoRa 復号(Decoding)
LoRaの無線 layer(Radio Layer) メッセージフォーマットは主にPreamble, 同期メッセージ(Sync message), ペイロード(Payload) そしてCRCを含む．
* Preamble: LoRa信号検出に使用
* Sync Message: LoRa Payloadの始まりを検出するのに使用
* Payload: MACコマンド及びメッセージを含む
* CRC: (up linkのみ)ブロック単位でのエラーチェックに使用

## LoRa復号のコンセプト
LoRaのエンコード中にLoRa信号の周波数を周期的にシフトしている．受信した周波数シフトされたLoRaチャープにその逆チャープを乗算すれば，送信信号の特定の周波数特性をもつ周波数一定の信号を得る．そしてシンボル全体にFFT/DFTを行えば高エネルギーをもつbinが送信シンボルを表すことになる．
具体例:
今，4つのpreamble symbleと2つの同期シンボル(32)，4つのメッセージシンボル(10,80,185,55)をもつLoRaメッセージを送信することを考える．拡散ファクタSFを8とすれば，それは以下のようになる(参照)
SFが8であるから，1シンボルに8bits(0-255)を送信することができる．完全なチャープは256ステップ(SF=8として)分割され，周波数の始まりはシンボルを表す.  
例えば:  
シンボル0もしくは256を表すメッセージシンボルはpreambleシンボルのようにみえ，シンボル128は周波数の始まりがちょうど真ん中(BW/2)である．  
そして受信側において，そのメッセージは逆チャープを乗算される．
これはそのスペクトルである(参照)
  
逆チャープをかければ，preambleとsync symbol，送信メッセージシンボルをしっかり確認することができる．受信メッセージシンボルは一定周波数をもつ．周波数(y軸)はシンボルを表しメッセージシンボルの長さ(x軸)は送信時間を表す．
逆チャープを受信シンボルに掛け合わせた後，周波数binが高エネルギーをもつことを確かめるためにFFT/DFTを行えば以下のような図が得られる(参照)
  
上のグラフにおいて，シンボルの高エネルギーをもつ周波数(FFTサイズ256)はデータを表している．この方法でデータは簡単に引き出せる．  
これは，100メッセージシンボルを送信した時のスペクトルを表したものである．(参照)
